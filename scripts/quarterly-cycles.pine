// Daye Quarterly Theory High/Low Lines (Pine Script v6).
// Previous day, 6hr, 90m, 22.5m cycle highs/lows as horizontal lines:
// solid extending until broken by one tick, then dashed and fixed at break bar.

//@version=6
indicator("Quarterly Cycles by @jbondata", overlay = true, max_lines_count = 500)

// -----------------------------------------------------------------------------
// 1. INPUTS
// -----------------------------------------------------------------------------
string TZ = "America/New_York"

showDaily   = input.bool(true, "Show previous day high/low", group = "Scales")
show6hr     = input.bool(true, "Show 6-hour cycle high/low", group = "Scales")
show90m     = input.bool(true, "Show 90-minute cycle high/low", group = "Scales")
showMicro   = input.bool(true, "Show 22.5-minute (micro) cycle high/low", group = "Scales")

nDaily  = input.int(5, "Number of previous daily cycles", 1, 125, group = "Cycles")
n6hr    = input.int(8, "Number of previous 6hr cycles", 1, 125, group = "Cycles")
n90m    = input.int(16, "Number of previous 90m cycles", 1, 125, group = "Cycles")
nMicro  = input.int(32, "Number of previous 22.5m cycles", 1, 125, group = "Cycles")

lineWidth   = input.int(1, "Line width", 1, 4, group = "Visual")
colorSolid  = input.color(color.new(color.black, 0), "Unbroken line color", group = "Visual")
colorDashed = input.color(color.new(color.black, 0), "Broken line color", group = "Visual")
hideCurrentSession = input.bool(true, "Hide current session H/L", group = "Visual", tooltip = "When on, in-progress session high/low lines are not drawn until the next session begins.")

// Cap total levels so 2 * (nDaily + n6hr + n90m + nMicro) <= 500
maxTotalLevels = 250.0
totalRequested = nDaily + n6hr + n90m + nMicro
mult = totalRequested > maxTotalLevels ? maxTotalLevels / totalRequested : 1.0
nD = math.max(1, math.round(nDaily * mult))
n6 = math.max(1, math.round(n6hr * mult))
n9 = math.max(1, math.round(n90m * mult))
nM = math.max(1, math.round(nMicro * mult))

// -----------------------------------------------------------------------------
// 2. BAR TIME IN EASTERN (TZ)
// -----------------------------------------------------------------------------
int nyYear   = year(time, TZ)
int nyMonth  = month(time, TZ)
int nyDay    = dayofmonth(time, TZ)
int nyHour   = hour(time, TZ)
int nyMin    = minute(time, TZ)
int minsMidnight = nyHour * 60 + nyMin

// Daily cycle id = YYYYMMDD
int dailyId = nyYear * 10000 + nyMonth * 100 + nyDay

// 6hr: Asia 18-24, London 0-6, NY AM 6-12, NY PM 12-18
int sixHrId = nyHour >= 18 ? dailyId * 10 + 3 : nyHour >= 12 ? dailyId * 10 + 2 : nyHour >= 6 ? dailyId * 10 + 1 : dailyId * 10 + 0

// 90m: 16 blocks per day. Block = floor(minsMidnight / 90)
int block90 = math.floor(minsMidnight / 90.0)
int ninetyId = dailyId * 100 + block90

// 22.5m: 64 blocks per day. Block = floor(minsMidnight / 22.5)
int block225 = math.floor(minsMidnight / 22.5)
int microId = dailyId * 1000 + block225

// -----------------------------------------------------------------------------
// 3. PERSISTENT ARRAYS
// -----------------------------------------------------------------------------
var array<float>  dailyHighs   = array.new_float()
var array<float>  dailyLows    = array.new_float()
var array<int>    dailyEndBars = array.new_int()
var array<int>    dailyStartTimesHigh = array.new_int()
var array<int>    dailyStartTimesLow  = array.new_int()

var array<float>  sixHighs   = array.new_float()
var array<float>  sixLows    = array.new_float()
var array<int>    sixEndBars = array.new_int()
var array<int>    sixStartTimesHigh = array.new_int()
var array<int>    sixStartTimesLow  = array.new_int()

var array<float>  ninetyHighs   = array.new_float()
var array<float>  ninetyLows   = array.new_float()
var array<int>    ninetyEndBars = array.new_int()
var array<int>    ninetyStartTimesHigh = array.new_int()
var array<int>    ninetyStartTimesLow  = array.new_int()

var array<float>  microHighs   = array.new_float()
var array<float>  microLows    = array.new_float()
var array<int>    microEndBars = array.new_int()
var array<int>    microStartTimesHigh = array.new_int()
var array<int>    microStartTimesLow  = array.new_int()

// Current cycle rolling high/low and bar time when each was set
var int   dailyPrevId   = na
var float dailyCurHigh  = high
var float dailyCurLow   = low
var int   dailyCurHighTime = na
var int   dailyCurLowTime  = na

var int   sixPrevId    = na
var float sixCurHigh   = high
var float sixCurLow    = low
var int   sixCurHighTime = na
var int   sixCurLowTime  = na

var int   ninetyPrevId  = na
var float ninetyCurHigh = high
var float ninetyCurLow = low
var int   ninetyCurHighTime = na
var int   ninetyCurLowTime  = na

var int   microPrevId   = na
var float microCurHigh  = high
var float microCurLow   = low
var int   microCurHighTime = na
var int   microCurLowTime  = na

// Line maps; removeLine must be defined before push* (they call removeLine)
var map<int, line>  lineHigh  = map.new<int, line>()
var map<int, line>  lineLow   = map.new<int, line>()

// Current (in-progress) session lines
var line dailyCurHighLine  = na
var line dailyCurLowLine   = na
var line sixCurHighLine    = na
var line sixCurLowLine     = na
var line ninetyCurHighLine = na
var line ninetyCurLowLine  = na
var line microCurHighLine  = na
var line microCurLowLine   = na

removeLine(int scale, int endBar) =>
    key = scale * 1000000000 + endBar
    if map.contains(lineHigh, key)
        line.delete(map.get(lineHigh, key))
        map.remove(lineHigh, key)
    if map.contains(lineLow, key)
        line.delete(map.get(lineLow, key))
        map.remove(lineLow, key)

pushDaily() =>
    if na(dailyPrevId) == false
        array.push(dailyHighs, dailyCurHigh)
        array.push(dailyLows, dailyCurLow)
        array.push(dailyEndBars, bar_index - 1)
        array.push(dailyStartTimesHigh, dailyCurHighTime)
        array.push(dailyStartTimesLow, dailyCurLowTime)
        while array.size(dailyHighs) > nD
            eb = array.get(dailyEndBars, 0)
            removeLine(0, eb)
            array.shift(dailyHighs)
            array.shift(dailyLows)
            array.shift(dailyEndBars)
            array.shift(dailyStartTimesHigh)
            array.shift(dailyStartTimesLow)

pushSix() =>
    if na(sixPrevId) == false
        array.push(sixHighs, sixCurHigh)
        array.push(sixLows, sixCurLow)
        array.push(sixEndBars, bar_index - 1)
        array.push(sixStartTimesHigh, sixCurHighTime)
        array.push(sixStartTimesLow, sixCurLowTime)
        while array.size(sixHighs) > n6
            eb = array.get(sixEndBars, 0)
            removeLine(1, eb)
            array.shift(sixHighs)
            array.shift(sixLows)
            array.shift(sixEndBars)
            array.shift(sixStartTimesHigh)
            array.shift(sixStartTimesLow)

pushNinety() =>
    if na(ninetyPrevId) == false
        array.push(ninetyHighs, ninetyCurHigh)
        array.push(ninetyLows, ninetyCurLow)
        array.push(ninetyEndBars, bar_index - 1)
        array.push(ninetyStartTimesHigh, ninetyCurHighTime)
        array.push(ninetyStartTimesLow, ninetyCurLowTime)
        while array.size(ninetyHighs) > n9
            eb = array.get(ninetyEndBars, 0)
            removeLine(2, eb)
            array.shift(ninetyHighs)
            array.shift(ninetyLows)
            array.shift(ninetyEndBars)
            array.shift(ninetyStartTimesHigh)
            array.shift(ninetyStartTimesLow)

pushMicro() =>
    if na(microPrevId) == false
        array.push(microHighs, microCurHigh)
        array.push(microLows, microCurLow)
        array.push(microEndBars, bar_index - 1)
        array.push(microStartTimesHigh, microCurHighTime)
        array.push(microStartTimesLow, microCurLowTime)
        while array.size(microHighs) > nM
            eb = array.get(microEndBars, 0)
            removeLine(3, eb)
            array.shift(microHighs)
            array.shift(microLows)
            array.shift(microEndBars)
            array.shift(microStartTimesHigh)
            array.shift(microStartTimesLow)

// Daily: record time of bar where high/low is set so lines stem from that bar
if na(dailyPrevId)
    dailyPrevId := dailyId
    dailyCurHighTime := time
    dailyCurLowTime := time
else if dailyId != dailyPrevId
    pushDaily()
    dailyCurHigh := high
    dailyCurLow := low
    dailyCurHighTime := time
    dailyCurLowTime := time
    dailyPrevId := dailyId
else
    if high >= dailyCurHigh
        dailyCurHighTime := time
    dailyCurHigh := math.max(dailyCurHigh, high)
    if low <= dailyCurLow
        dailyCurLowTime := time
    dailyCurLow := math.min(dailyCurLow, low)

// 6hr
if na(sixPrevId)
    sixPrevId := sixHrId
    sixCurHighTime := time
    sixCurLowTime := time
else if sixHrId != sixPrevId
    pushSix()
    sixCurHigh := high
    sixCurLow := low
    sixCurHighTime := time
    sixCurLowTime := time
    sixPrevId := sixHrId
else
    if high >= sixCurHigh
        sixCurHighTime := time
    sixCurHigh := math.max(sixCurHigh, high)
    if low <= sixCurLow
        sixCurLowTime := time
    sixCurLow := math.min(sixCurLow, low)

// 90m
if na(ninetyPrevId)
    ninetyPrevId := ninetyId
    ninetyCurHighTime := time
    ninetyCurLowTime := time
else if ninetyId != ninetyPrevId
    pushNinety()
    ninetyCurHigh := high
    ninetyCurLow := low
    ninetyCurHighTime := time
    ninetyCurLowTime := time
    ninetyPrevId := ninetyId
else
    if high >= ninetyCurHigh
        ninetyCurHighTime := time
    ninetyCurHigh := math.max(ninetyCurHigh, high)
    if low <= ninetyCurLow
        ninetyCurLowTime := time
    ninetyCurLow := math.min(ninetyCurLow, low)

// 22.5m micro
if na(microPrevId)
    microPrevId := microId
    microCurHighTime := time
    microCurLowTime := time
else if microId != microPrevId
    pushMicro()
    microCurHigh := high
    microCurLow := low
    microCurHighTime := time
    microCurLowTime := time
    microPrevId := microId
else
    if high >= microCurHigh
        microCurHighTime := time
    microCurHigh := math.max(microCurHigh, high)
    if low <= microCurLow
        microCurLowTime := time
    microCurLow := math.min(microCurLow, low)

// -----------------------------------------------------------------------------
// 4. BREAK STATE
// -----------------------------------------------------------------------------
var map<int, int> breakBarHigh = map.new<int, int>()
var map<int, int> breakBarLow  = map.new<int, int>()
var map<int, int> breakTimeHigh = map.new<int, int>()
var map<int, int> breakTimeLow  = map.new<int, int>()

checkBreakHigh(int scale, int endBar, float level) =>
    key = scale * 1000000000 + endBar
    if not map.contains(breakBarHigh, key) and high > level
        map.put(breakBarHigh, key, bar_index)
        map.put(breakTimeHigh, key, time)

checkBreakLow(int scale, int endBar, float level) =>
    key = scale * 1000000000 + endBar
    if not map.contains(breakBarLow, key) and low < level
        map.put(breakBarLow, key, bar_index)
        map.put(breakTimeLow, key, time)

// -----------------------------------------------------------------------------
// 5. LINE OBJECTS
// -----------------------------------------------------------------------------

drawLevel(int scale, int endBar, float price, bool isHigh, int startTime) =>
    key = scale * 1000000000 + endBar
    bool broken = false
    int x2Time = time
    if isHigh
        checkBreakHigh(scale, endBar, price)
        broken := map.contains(breakBarHigh, key)
        if broken
            x2Time := map.get(breakTimeHigh, key)
    else
        checkBreakLow(scale, endBar, price)
        broken := map.contains(breakBarLow, key)
        if broken
            x2Time := map.get(breakTimeLow, key)
    map_use = isHigh ? lineHigh : lineLow
    ln = map.contains(map_use, key) ? map.get(map_use, key) : line.new(startTime, price, x2Time, price, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
    if not map.contains(map_use, key)
        map.put(map_use, key, ln)
    line.set_x2(ln, x2Time)
    line.set_style(ln, broken ? line.style_dashed : line.style_solid)
    line.set_color(ln, broken ? colorDashed : colorSolid)

// Iterate scales and draw
if showDaily and array.size(dailyHighs) > 0
    for i = 0 to array.size(dailyHighs) - 1
        eb = array.get(dailyEndBars, i)
        drawLevel(0, eb, array.get(dailyHighs, i), true, array.get(dailyStartTimesHigh, i))
        drawLevel(0, eb, array.get(dailyLows, i), false, array.get(dailyStartTimesLow, i))

if show6hr and array.size(sixHighs) > 0
    for i = 0 to array.size(sixHighs) - 1
        eb = array.get(sixEndBars, i)
        drawLevel(1, eb, array.get(sixHighs, i), true, array.get(sixStartTimesHigh, i))
        drawLevel(1, eb, array.get(sixLows, i), false, array.get(sixStartTimesLow, i))

if show90m and array.size(ninetyHighs) > 0
    for i = 0 to array.size(ninetyHighs) - 1
        eb = array.get(ninetyEndBars, i)
        drawLevel(2, eb, array.get(ninetyHighs, i), true, array.get(ninetyStartTimesHigh, i))
        drawLevel(2, eb, array.get(ninetyLows, i), false, array.get(ninetyStartTimesLow, i))

if showMicro and array.size(microHighs) > 0
    for i = 0 to array.size(microHighs) - 1
        eb = array.get(microEndBars, i)
        drawLevel(3, eb, array.get(microHighs, i), true, array.get(microStartTimesHigh, i))
        drawLevel(3, eb, array.get(microLows, i), false, array.get(microStartTimesLow, i))

// Current session H/L lines
if hideCurrentSession
    if not na(dailyCurHighLine)
        line.delete(dailyCurHighLine)
        dailyCurHighLine := na
    if not na(dailyCurLowLine)
        line.delete(dailyCurLowLine)
        dailyCurLowLine := na
    if not na(sixCurHighLine)
        line.delete(sixCurHighLine)
        sixCurHighLine := na
    if not na(sixCurLowLine)
        line.delete(sixCurLowLine)
        sixCurLowLine := na
    if not na(ninetyCurHighLine)
        line.delete(ninetyCurHighLine)
        ninetyCurHighLine := na
    if not na(ninetyCurLowLine)
        line.delete(ninetyCurLowLine)
        ninetyCurLowLine := na
    if not na(microCurHighLine)
        line.delete(microCurHighLine)
        microCurHighLine := na
    if not na(microCurLowLine)
        line.delete(microCurLowLine)
        microCurLowLine := na
else
    if showDaily and na(dailyPrevId) == false
        if na(dailyCurHighLine)
            dailyCurHighLine := line.new(dailyCurHighTime, dailyCurHigh, time, dailyCurHigh, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(dailyCurHighLine, dailyCurHighTime)
            line.set_y1(dailyCurHighLine, dailyCurHigh)
            line.set_x2(dailyCurHighLine, time)
            line.set_y2(dailyCurHighLine, dailyCurHigh)
        if na(dailyCurLowLine)
            dailyCurLowLine := line.new(dailyCurLowTime, dailyCurLow, time, dailyCurLow, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(dailyCurLowLine, dailyCurLowTime)
            line.set_y1(dailyCurLowLine, dailyCurLow)
            line.set_x2(dailyCurLowLine, time)
            line.set_y2(dailyCurLowLine, dailyCurLow)
    if show6hr and na(sixPrevId) == false
        if na(sixCurHighLine)
            sixCurHighLine := line.new(sixCurHighTime, sixCurHigh, time, sixCurHigh, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(sixCurHighLine, sixCurHighTime)
            line.set_y1(sixCurHighLine, sixCurHigh)
            line.set_x2(sixCurHighLine, time)
            line.set_y2(sixCurHighLine, sixCurHigh)
        if na(sixCurLowLine)
            sixCurLowLine := line.new(sixCurLowTime, sixCurLow, time, sixCurLow, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(sixCurLowLine, sixCurLowTime)
            line.set_y1(sixCurLowLine, sixCurLow)
            line.set_x2(sixCurLowLine, time)
            line.set_y2(sixCurLowLine, sixCurLow)
    if show90m and na(ninetyPrevId) == false
        if na(ninetyCurHighLine)
            ninetyCurHighLine := line.new(ninetyCurHighTime, ninetyCurHigh, time, ninetyCurHigh, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(ninetyCurHighLine, ninetyCurHighTime)
            line.set_y1(ninetyCurHighLine, ninetyCurHigh)
            line.set_x2(ninetyCurHighLine, time)
            line.set_y2(ninetyCurHighLine, ninetyCurHigh)
        if na(ninetyCurLowLine)
            ninetyCurLowLine := line.new(ninetyCurLowTime, ninetyCurLow, time, ninetyCurLow, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(ninetyCurLowLine, ninetyCurLowTime)
            line.set_y1(ninetyCurLowLine, ninetyCurLow)
            line.set_x2(ninetyCurLowLine, time)
            line.set_y2(ninetyCurLowLine, ninetyCurLow)
    if showMicro and na(microPrevId) == false
        if na(microCurHighLine)
            microCurHighLine := line.new(microCurHighTime, microCurHigh, time, microCurHigh, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(microCurHighLine, microCurHighTime)
            line.set_y1(microCurHighLine, microCurHigh)
            line.set_x2(microCurHighLine, time)
            line.set_y2(microCurHighLine, microCurHigh)
        if na(microCurLowLine)
            microCurLowLine := line.new(microCurLowTime, microCurLow, time, microCurLow, xloc.bar_time, extend.none, colorSolid, line.style_solid, lineWidth)
        else
            line.set_x1(microCurLowLine, microCurLowTime)
            line.set_y1(microCurLowLine, microCurLow)
            line.set_x2(microCurLowLine, time)
            line.set_y2(microCurLowLine, microCurLow)