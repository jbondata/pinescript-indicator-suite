// This Pine Script code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// True Opens. 00:00 and 8:30 AM New York EST horizontal rays
//@version=6
indicator("True Opens by @jbondata", overlay = true, max_lines_count = 500, max_labels_count = 500)

// Inputs: Midnight (True Day Open)
color lineColor = input.color(color.new(color.blue, 0), "Line color", group = "00:00 True Day Open")
int lineWidth = input.int(2, "Line width", minval = 1, maxval = 4, group = "00:00 True Day Open")
color textColor = input.color(color.new(color.blue, 0), "Text color", group = "00:00 True Day Open")
string textSizeInput = input.string("Small", "Text size", options = ["Tiny", "Small", "Normal", "Large", "Huge"], group = "00:00 True Day Open")

// Inputs: 8:30 AM Open
color lineColor830 = input.color(color.new(color.orange, 0), "Line color", group = "8:30 AM Open")
int lineWidth830 = input.int(2, "Line width", minval = 1, maxval = 4, group = "8:30 AM Open")
color textColor830 = input.color(color.new(color.orange, 0), "Text color", group = "8:30 AM Open")
string textSize830Input = input.string("Small", "Text size", options = ["Tiny", "Small", "Normal", "Large", "Huge"], group = "8:30 AM Open")

string labelSize = textSizeInput == "Tiny" ? size.tiny : textSizeInput == "Small" ? size.small : textSizeInput == "Normal" ? size.normal : textSizeInput == "Large" ? size.large : size.huge
string labelSize830 = textSize830Input == "Tiny" ? size.tiny : textSize830Input == "Small" ? size.small : textSize830Input == "Normal" ? size.normal : textSize830Input == "Large" ? size.large : textSize830Input == "Huge" ? size.huge : size.huge

// New York (EST/EDT)
string nyTz = "America/New_York"
int yearNy = year(time, nyTz)
int monthNy = month(time, nyTz)
int dayNy = dayofmonth(time, nyTz)
int nyMidnight = timestamp(nyTz, yearNy, monthNy, dayNy, 0, 0, 0)
int ny0830 = timestamp(nyTz, yearNy, monthNy, dayNy, 8, 30, 0)

// First bar of the NY day
bool isNyOpenBar = time >= nyMidnight and (na(time[1]) or time[1] < nyMidnight)

// First bar at or after 8:30 NY
bool is0830Bar = time >= ny0830 and (na(time[1]) or time[1] < ny0830)

// Store the single previous midnight true open and its timestamp
var float lastTrueOpen = na
var int lastMidnightTs = na
var line ray = na
var label openLabel = na

// Store the single previous 8:30 AM open and its timestamp
var float last0830Open = na
var int last0830Ts = na
var line ray0830 = na
var label label0830 = na

if isNyOpenBar
    lastTrueOpen := open
    lastMidnightTs := time
    if not na(ray)
        line.delete(ray)
        ray := na
    if not na(openLabel)
        label.delete(openLabel)
        openLabel := na

if is0830Bar
    last0830Open := open
    last0830Ts := time
    if not na(ray0830)
        line.delete(ray0830)
        ray0830 := na
    if not na(label0830)
        label.delete(label0830)
        label0830 := na

// Only draw after 00:02 NY so the 00:00 to 00:01 candle has closed
int twoMinutesMs = 2 * 60 * 1000
bool isPast002 = time >= nyMidnight + twoMinutesMs

// Only draw 8:30 line after 8:32 NY so the 8:30 to 8:31 candle has closed
bool isPast0832 = time >= ny0830 + twoMinutesMs

if isPast002 and not na(lastTrueOpen) and not na(lastMidnightTs)
    if na(ray)
        ray := line.new(lastMidnightTs, lastTrueOpen, time, lastTrueOpen, xloc = xloc.bar_time, color = lineColor, width = lineWidth, style = line.style_dotted)
        openLabel := label.new(time, lastTrueOpen, "True Day Open", xloc = xloc.bar_time, yloc = yloc.price, style = label.style_none, textcolor = textColor, size = labelSize)
    else
        line.set_xy2(ray, time, lastTrueOpen)
        label.set_xy(openLabel, time, lastTrueOpen)
        label.set_size(openLabel, labelSize)

if isPast0832 and not na(last0830Open) and not na(last0830Ts)
    if na(ray0830)
        ray0830 := line.new(last0830Ts, last0830Open, time, last0830Open, xloc = xloc.bar_time, color = lineColor830, width = lineWidth830, style = line.style_dotted)
        label0830 := label.new(time, last0830Open, "8:30 Open", xloc = xloc.bar_time, yloc = yloc.price, style = label.style_none, textcolor = textColor830, size = labelSize830)
    else
        line.set_xy2(ray0830, time, last0830Open)
        label.set_xy(label0830, time, last0830Open)
        label.set_size(label0830, labelSize830)